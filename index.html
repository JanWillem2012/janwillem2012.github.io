<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roostermeldingen</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>

    <div id="loading-screen" class="card center-content">
        <div class="loader"></div>
        <h2>App laden...</h2>
        <p>Even geduld a.u.b.</p>
    </div>

    <div id="install-instructions" class="card hidden">
        <h1>憧 Installeer de App</h1>
        <p>Voeg deze app toe aan je startscherm om meldingen te kunnen ontvangen.</p>
        <div id="ios-instructions" class="hidden">
            <p>Tik onderaan op het <strong>delen-icoon</strong> en kies <strong>'Zet op beginscherm'</strong>.</p>
        </div>
    </div>

    <div id="permission-section" class="card hidden">
        <h1>粕 Meldingen</h1>
        <p>Zet meldingen aan voor updates.</p>
        <button id="enable-btn" class="btn-primary">Meld je aan</button>
        <button onclick="forceHomepage()" class="btn-logout" style="margin-top:15px;">Nu niet</button>
    </div>

    <div id="homepage" class="hidden">
        <div class="card">
            <div class="header-flex">
                <h2 style="margin:0;">匠 Welkom</h2>
            </div>
            <p>Hier verschijnen je meldingen.</p>
        </div>

        <div class="card">
            <h2>糖 Geschiedenis</h2>
            <p id="no-msg">Geen berichten gevonden.</p>
            <ul id="history-list"></ul>
            <button onclick="clearHistory()" class="btn-danger">Wissen</button>
        </div>
    </div>

    <script>
        const ONESIGNAL_APP_ID = "34b6e89d-0d33-405e-8ee4-76ef90fa699a";
        let appIsReady = false;

        // --- VEILIGHEIDS TIMER ---
        // Als de app na 4 seconden nog niet geladen is, forceer dan de homepage.
        setTimeout(() => {
            if (!appIsReady) {
                console.log("OneSignal duurde te lang, app wordt geforceerd geopend.");
                checkAccess(true); // Forceer check
            }
        }, 4000);

        window.onload = () => {
            // Start normaal
            checkAccess(false);
        };

        function checkAccess(force) {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            
            // Als we niet in app-modus zitten, toon installatie-instructies
            if (!isStandalone) {
                showSection('install-instructions');
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.getElementById('ios-instructions').classList.remove('hidden');
                }
            } else {
                // We zitten in de app. Probeer OneSignal, of forceer als het te lang duurt.
                if (force) {
                    showSection('homepage');
                    loadFromDB();
                } else {
                    initOneSignal();
                }
            }
        }

        function initOneSignal() {
            window.OneSignalDeferred = window.OneSignalDeferred || [];
            
            try {
                OneSignalDeferred.push(async function(OneSignal) {
                    await OneSignal.init({ appId: ONESIGNAL_APP_ID });
                    
                    // Check status
                    const isOptedIn = OneSignal.User.PushSubscription.optedIn;
                    const permission = Notification.permission;

                    if (isOptedIn || permission === "granted") {
                        showSection('homepage');
                        loadFromDB();
                    } else {
                        showSection('permission-section');
                    }
                });
            } catch (error) {
                console.error("OneSignal Fout:", error);
                showSection('homepage'); // Bij fout toch openen
            }
        }

        document.getElementById('enable-btn').addEventListener('click', () => {
            OneSignalDeferred.push(async (OneSignal) => {
                await OneSignal.Slidedown.promptPush();
                // Wacht even en check dan permissie
                setTimeout(() => {
                    if (Notification.permission === "granted") {
                        showSection('homepage');
                        loadFromDB();
                    }
                }, 1500);
            });
        });

        function forceHomepage() {
            showSection('homepage');
            loadFromDB();
        }

        function showSection(id) {
            appIsReady = true; // Timer stopt nu met tellen
            document.getElementById('loading-screen').style.display = 'none';

            ['install-instructions', 'permission-section', 'homepage'].forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        // --- DATABASE LOGICA ---
        function loadFromDB() {
            try {
                const request = indexedDB.open("NotificationHistory", 1);
                request.onupgradeneeded = (e) => {
                    e.target.result.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
                };
                request.onsuccess = (e) => {
                    const db = e.target.result;
                    const transaction = db.transaction("messages", "readonly");
                    const store = transaction.objectStore("messages");
                    const getAll = store.getAll();
                    getAll.onsuccess = () => renderHistory(getAll.result.reverse());
                };
            } catch(e) { console.log("DB Error", e); }
        }

        function renderHistory(history) {
            const list = document.getElementById('history-list');
            const noMsg = document.getElementById('no-msg');
            list.innerHTML = '';
            if (history && history.length > 0) {
                noMsg.style.display = 'none';
                history.forEach(item => {
                    let li = document.createElement('li');
                    li.className = 'notif-item';
                    li.innerHTML = `<strong>${item.title}</strong><br>${item.body}<span class="notif-time">${item.time}</span>`;
                    list.appendChild(li);
                });
            } else {
                noMsg.style.display = 'block';
            }
        }

        function clearHistory() {
            const request = indexedDB.open("NotificationHistory", 1);
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction("messages", "readwrite");
                transaction.objectStore("messages").clear();
                renderHistory([]);
            };
        }
    </script>
</body>
</html>
