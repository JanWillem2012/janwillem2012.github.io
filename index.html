<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roostermeldingen</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>

    <div id="install-instructions" class="card hidden">
        <h1>ðŸ“² Installeer de App</h1>
        <p>Voeg deze app toe aan je startscherm om meldingen te kunnen ontvangen.</p>
        <div id="ios-instructions" class="hidden">
            <p>Tik onderaan op het <strong>delen-icoon</strong> en kies <strong>'Zet op beginscherm'</strong>.</p>
        </div>
    </div>

    <div id="permission-section" class="card hidden">
        <h1>ðŸ”” Meldingen</h1>
        <p>Zet je meldingen aan om updates te ontvangen.</p>
        <button id="enable-btn" class="btn-primary">Meld je aan voor meldingen</button>
    </div>

    <div id="homepage" class="hidden">
        <div class="card">
            <h2 style="margin:0;">ðŸ‘‹ Welkom bij je Rooster</h2>
            <p>Hieronder zie je de ontvangen meldingen.</p>
        </div>

        <div class="card">
            <h2>ðŸ“œ Geschiedenis</h2>
            <p id="no-msg">Geen berichten gevonden.</p>
            <ul id="history-list"></ul>
            <button onclick="clearHistory()" class="btn-danger">Wissen</button>
        </div>
    </div>

    <script>
        const ONESIGNAL_APP_ID = "34b6e89d-0d33-405e-8ee4-76ef90fa699a";

        // Start de controle zodra de pagina laadt
        window.onload = () => {
            checkDevice();
        };

        // --- STAP 1: Is de app geÃ¯nstalleerd? ---
        function checkDevice() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            
            if (!isStandalone) {
                showSection('install-instructions');
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    document.getElementById('ios-instructions').classList.remove('hidden');
                }
            } else {
                initOneSignal();
            }
        }

        // --- STAP 2: OneSignal Initialisatie ---
        function initOneSignal() {
            window.OneSignalDeferred = window.OneSignalDeferred || [];
            OneSignalDeferred.push(async function(OneSignal) {
                await OneSignal.init({ appId: ONESIGNAL_APP_ID });

                // Check of de gebruiker al is aangemeld
                const isOptedIn = OneSignal.User.PushSubscription.optedIn;
                const permission = Notification.permission;

                if (isOptedIn || permission === "granted") {
                    showSection('homepage');
                    loadFromDB();
                } else {
                    showSection('permission-section');
                }
            });
        }

        // --- STAP 3: Knop om meldingen te activeren ---
        document.getElementById('enable-btn').addEventListener('click', () => {
            OneSignalDeferred.push(async (OneSignal) => {
                // Toon de officiÃ«le prompt
                await OneSignal.Slidedown.promptPush();
                
                // Controleer na 2 seconden of de gebruiker 'Toestaan' heeft geklikt
                setTimeout(() => {
                    if (Notification.permission === "granted") {
                        showSection('homepage');
                        loadFromDB();
                    }
                }, 2000);
            });
        });

        function showSection(id) {
            ['install-instructions', 'permission-section', 'homepage'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        // --- STAP 4: Database (IndexedDB) ---
        function loadFromDB() {
            const request = indexedDB.open("NotificationHistory", 1);
            request.onupgradeneeded = (e) => {
                e.target.result.createObjectStore("messages", { keyPath: "id", autoIncrement: true });
            };
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction("messages", "readonly");
                const store = transaction.objectStore("messages");
                const getAll = store.getAll();
                getAll.onsuccess = () => renderHistory(getAll.result.reverse());
            };
        }

        function renderHistory(history) {
            const list = document.getElementById('history-list');
            const noMsg = document.getElementById('no-msg');
            list.innerHTML = '';
            if (history.length > 0) {
                noMsg.style.display = 'none';
                history.forEach(item => {
                    let li = document.createElement('li');
                    li.className = 'notif-item';
                    li.innerHTML = `<strong>${item.title}</strong><br>${item.body}<span class="notif-time">${item.time}</span>`;
                    list.appendChild(li);
                });
            } else {
                noMsg.style.display = 'block';
            }
        }

        function clearHistory() {
            const request = indexedDB.open("NotificationHistory", 1);
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction("messages", "readwrite");
                transaction.objectStore("messages").clear();
                renderHistory([]);
            };
        }
    </script>
</body>
</html>
